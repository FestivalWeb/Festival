<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ë¯¸ì§€ ê²Œì‹œíŒ í†µí•© í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f4f4f9; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { margin-top: 15px; padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 1em; }
        button.blue { background-color: #007bff; }
        .preview-box { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .preview-img { width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .post-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; gap: 15px; }
        .post-thumb { width: 80px; height: 80px; background: #eee; border-radius: 4px; object-fit: cover; }
    </style>
</head>
<body>

    <h1>ğŸ“ ì›¹ ë¸Œë¼ìš°ì € í†µí•© í…ŒìŠ¤íŠ¸</h1>

    <div class="section">
        <h2>1. ë¡œê·¸ì¸ (í•„ìˆ˜)</h2>
        <p>1. ë²„íŠ¼ í´ë¦­ -> ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ -> í° í™”ë©´(JSON) ëœ¨ë©´ ì„±ê³µ</p>
        <p>2. <b>ë’¤ë¡œ ê°€ê¸°</b> ëˆ„ë¥´ê³  -> <b>ìƒˆë¡œê³ ì¹¨(F5)</b> í•„ìˆ˜!</p>
        <a href="http://localhost:8080/login/page">
            <button class="blue">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</button>
        </a>
    </div>

    <div class="section">
        <h2>2. ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
        <input type="file" id="fileInput" multiple accept="image/*">
        <button onclick="uploadFiles()">ì´ë¯¸ì§€ ì„œë²„ì— ì˜¬ë¦¬ê¸°</button>
        <div class="preview-box" id="previewBox"></div>
    </div>

    <div class="section">
        <h2>3. ê²Œì‹œê¸€ ì‘ì„±</h2>
        <label>ì œëª©</label>
        <input type="text" id="title" placeholder="ì œëª©">
        <label>ë‚´ìš©</label>
        <textarea id="context" rows="3" placeholder="ë‚´ìš©"></textarea>
        <button onclick="createPost()">ê¸€ ì‘ì„± ì™„ë£Œ</button>
    </div>

    <div class="section">
        <h2>4. ê²°ê³¼ í™•ì¸</h2>
        <button class="blue" onclick="getPostList()">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <div id="postList"></div>
    </div>

    <script>
        const BASE_URL = "http://localhost:8080/api";
        let uploadedFileIds = [];

        // 1. íŒŒì¼ ì—…ë¡œë“œ
        async function uploadFiles() {
            const fileInput = document.getElementById("fileInput");
            if (fileInput.files.length === 0) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");

            const formData = new FormData();
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append("files", fileInput.files[i]);
            }

            try {
                const res = await fetch(`${BASE_URL}/media/upload`, {
                    method: "POST",
                    body: formData,
                    credentials: 'include' // [ì¤‘ìš”] ì¿ í‚¤ í¬í•¨ ì „ì†¡
                });

                if (res.ok) {
                    const data = await res.json();
                    data.forEach(file => uploadedFileIds.push(file.fileId));
                    
                    const previewBox = document.getElementById("previewBox");
                    data.forEach(file => {
                        const img = document.createElement("img");
                        img.src = "http://localhost:8080" + file.url;
                        img.className = "preview-img";
                        previewBox.appendChild(img);
                    });
                    alert("ì—…ë¡œë“œ ì„±ê³µ! (ë©”ëª¨ë¦¬ì— ID ì €ì¥ë¨)");
                } else {
                    alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
                }
            } catch (e) { alert("ì—ëŸ¬: " + e); }
        }

        // 2. ê¸€ ì‘ì„±
        async function createPost() {
            const title = document.getElementById("title").value;
            const context = document.getElementById("context").value;

            const data = {
                title: title,
                context: context,
                fileIds: uploadedFileIds
            };

            try {
                const res = await fetch(`${BASE_URL}/posts`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                    credentials: 'include' // [ì¤‘ìš”] ì¿ í‚¤(ì„¸ì…˜) í¬í•¨ ì „ì†¡!
                });

                if (res.ok) {
                    alert("ì„±ê³µ! ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    getPostList();
                } else if (res.status === 401) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. 1ë²ˆ ê³¼ì •ì„ ë‹¤ì‹œ í•´ì£¼ì„¸ìš”.");
                } else {
                    const txt = await res.text();
                    alert("ì‹¤íŒ¨: " + txt);
                }
            } catch (e) { alert("ì—ëŸ¬: " + e); }
        }

        // 3. ëª©ë¡ ì¡°íšŒ
        async function getPostList() {
            try {
                const res = await fetch(`${BASE_URL}/posts?size=10&sort=postId,desc`, {
                    credentials: 'include' // [ì¤‘ìš”]
                });
                const data = await res.json();
                
                const listDiv = document.getElementById("postList");
                listDiv.innerHTML = "";

                data.content.forEach(post => {
                    const thumbSrc = post.thumbnailUri 
                        ? "http://localhost:8080" + post.thumbnailUri 
                        : "https://via.placeholder.com/80?text=No+Img";

                    const item = document.createElement("div");
                    item.className = "post-item";
                    item.innerHTML = `
                        <img src="${thumbSrc}" class="post-thumb">
                        <div>
                            <b>#${post.postId} ${post.title}</b><br>
                            <small>${post.userId}</small>
                        </div>
                    `;
                    listDiv.appendChild(item);
                });
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>